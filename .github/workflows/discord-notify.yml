name: Discord notifications

on:
  release:
    types: [published]
  push:
    branches: ["main", "master"]
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review, converted_to_draft]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build message content
        id: msg
        shell: bash
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"

          # Default webhook (dev). Override for releases.
          WEBHOOK="${{ secrets.DISCORD_WEBHOOK_DEV }}"

          if [ "$EVENT" = "release" ]; then
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK_RELEASE }}"
            NAME="${{ github.event.release.name }}"
            TAG="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            CONTENT="## ðŸš€ ${NAME:-New Release} (${TAG})\n**Repo:** ${REPO}\n**Link:** ${URL}"

          elif [ "$EVENT" = "push" ]; then
            BRANCH="${{ github.ref_name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
            SHORT_SHA="$(echo "${{ github.sha }}" | cut -c1-7)"
            COMMIT_FIRST_LINE="$(echo "$COMMIT_MSG" | head -n 1)"
            CONTENT="**ðŸ“ Push** to \`${BRANCH}\` â€” \`${SHORT_SHA}\`\n**Repo:** ${REPO}\n**Message:** ${COMMIT_FIRST_LINE}\n**Link:** ${COMMIT_URL}"

          elif [ "$EVENT" = "issues" ]; then
            ACTION="${{ github.event.action }}"
            NUM="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"
            EMOJI="ðŸª²"
            if [ "$ACTION" = "closed" ]; then EMOJI="âœ…"; fi
            CONTENT="**${EMOJI} Issue ${ACTION}** â€” #${NUM}\n**Repo:** ${REPO}\n**Title:** ${TITLE}\n**Link:** ${URL}"

          elif [ "$EVENT" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            NUM="${{ github.event.pull_request.number }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"

            EMOJI="ðŸ”€"
            if [ "$ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                ACTION="merged"
                EMOJI="âœ…"
              else
                EMOJI="ðŸš«"
              fi
            fi

            CONTENT="**${EMOJI} PR ${ACTION}** â€” #${NUM}\n**Repo:** ${REPO}\n**Title:** ${TITLE}\n**Link:** ${URL}"
          else
            CONTENT="GitHub event: ${EVENT} in ${REPO}"
          fi

          echo "webhook=$WEBHOOK" >> "$GITHUB_OUTPUT"
          {
            python3 - << 'PY'
import json, os
print(json.dumps({"content": os.environ["CONTENT"]}))
PY
          } > payload.json
        env:
          CONTENT: ""

      - name: Send to Discord
        shell: bash
        run: |
          curl -sS -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "${{ steps.msg.outputs.webhook }}"
